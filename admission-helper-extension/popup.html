<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni-Assist: Student Portal Helper</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for chat area */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-track {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="w-96 p-0 m-0 bg-gray-50 font-sans">

    <div class="p-4 bg-indigo-700 text-white rounded-t-xl shadow-lg">
        <h1 class="text-xl font-bold tracking-tight">Uni-Assist Helper</h1>
        <p class="text-indigo-200 text-sm">Automate forms and get instant AI answers.</p>
    </div>

    <div id="main-content" class="p-4 space-y-4">
        
        <!-- Feature Cards -->
        <div class="grid grid-cols-2 gap-3">
            <!-- Admission Process Solution -->
            <div class="bg-white p-3 rounded-lg shadow-md border-t-4 border-indigo-500 hover:shadow-xl transition duration-300">
                <div class="text-lg font-semibold text-gray-800">Admission Automator</div>
                <p class="text-xs text-gray-500 mt-1">One-click form filling & status tracking.</p>
                <button class="mt-2 w-full text-xs bg-indigo-100 text-indigo-700 py-1 px-2 rounded font-medium hover:bg-indigo-200">Track & Fill</button>
            </div>
            
            <!-- Hostel Allotment Solution -->
            <div class="bg-white p-3 rounded-lg shadow-md border-t-4 border-green-500 hover:shadow-xl transition duration-300">
                <div class="text-lg font-semibold text-gray-800">Hostel Notifier</div>
                <p class="text-xs text-gray-500 mt-1">Room visibility & allotment notifications.</p>
                <button class="mt-2 w-full text-xs bg-green-100 text-green-700 py-1 px-2 rounded font-medium hover:bg-green-200">Check Status</button>
            </div>
        </div>

        <!-- General Issue Solution: AI Assistant -->
        <div class="bg-white p-4 rounded-lg shadow-md border-t-4 border-yellow-500">
            <h2 class="text-lg font-semibold text-gray-800 mb-2">ðŸ¤– AI Student Assistant</h2>
            <p class="text-sm text-gray-600 mb-3">Ask about deadlines, policies, or find relevant links!</p>
            
            <div id="chat-container" class="chat-container h-48 overflow-y-auto p-2 border border-gray-200 rounded-lg bg-gray-50 space-y-3">
                <!-- Initial Bot Message -->
                <div class="flex justify-start">
                    <div class="max-w-[80%] bg-indigo-100 text-indigo-900 text-sm p-2 rounded-xl rounded-tl-none shadow">
                        Hi there! I'm your Uni-Assist bot. I can use Google Search to find up-to-date info. Try asking: "What are the fees for the MBA program?"
                    </div>
                </div>
            </div>

            <div class="mt-3 flex space-x-2">
                <input type="text" id="user-input" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your question..." onkeypress="if(event.key === 'Enter') sendMessage()">
                <button id="send-button" class="bg-indigo-600 text-white p-2 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-indigo-400 transition duration-150" onclick="sendMessage()">
                    Send
                </button>
            </div>
            <div id="error-message" class="text-xs text-red-600 mt-2 hidden"></div>
        </div>
    </div>

    <script type="text/javascript">
        // --- Core Gemini API Setup ---
        // These variables are provided by the canvas environment.
        const apiKey = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Utility to handle exponential backoff for retries
        const MAX_RETRIES = 3;

        /**
         * Converts a markdown string to HTML for display in the chat.
         * Simple conversion for bold, list items, and newlines.
         * @param {string} markdownText - The text in markdown format.
         * @returns {string} HTML string.
         */
        function markdownToHtml(markdownText) {
            let html = markdownText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\n/g, '<br>'); // Newlines
            return html;
        }

        /**
         * Simulates an API call with exponential backoff.
         * @param {object} payload - The request body for the Gemini API.
         * @returns {Promise<object>} The JSON response object.
         */
        async function fetchWithRetry(payload) {
            let lastError = null;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Throw error if response status is not OK (e.g., 400, 500)
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    lastError = error;
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            throw new Error(`API failed after ${MAX_RETRIES} attempts: ${lastError.message}`);
        }
        
        /**
         * Appends a message to the chat container.
         * @param {string} text - The message content.
         * @param {boolean} isUser - True if the message is from the user.
         * @param {string[]} [sources=[]] - Array of source objects for grounding.
         */
        function appendMessage(text, isUser, sources = []) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            const baseClasses = "max-w-[85%] text-sm p-2 rounded-xl shadow";
            bubble.className = isUser
                ? `${baseClasses} bg-indigo-600 text-white rounded-br-none`
                : `${baseClasses} bg-indigo-100 text-indigo-900 rounded-tl-none`;

            bubble.innerHTML = markdownToHtml(text); // Use markdownToHtml here

            messageDiv.appendChild(bubble);
            chatContainer.appendChild(messageDiv);

            // Add sources if available and not a user message
            if (sources.length > 0 && !isUser) {
                const sourcesDiv = document.createElement('div');
                sourcesDiv.className = "text-xs text-gray-500 mt-1 space-y-1 ml-2";
                sourcesDiv.innerHTML = '<strong>Sources:</strong>';
                sources.forEach(source => {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.textContent = source.title || source.uri;
                    link.target = '_blank';
                    link.className = 'block truncate hover:text-indigo-600';
                    sourcesDiv.appendChild(link);
                });
                bubble.appendChild(sourcesDiv);
            }
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        /**
         * Displays a temporary loading indicator.
         * @returns {HTMLElement} The loading element.
         */
        function showLoading() {
            const chatContainer = document.getElementById('chat-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="max-w-[80%] bg-indigo-100 text-indigo-900 text-sm p-2 rounded-xl rounded-tl-none shadow">
                    <div class="flex items-center space-x-2">
                        <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Thinking...</span>
                    </div>
                </div>
            `;
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return loadingDiv;
        }

        /**
         * Main function to send the user's message to the Gemini API.
         */
        async function sendMessage() {
            const inputElement = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const errorMessageDiv = document.getElementById('error-message');
            const userQuery = inputElement.value.trim();

            if (!userQuery) return;

            // 1. Display user message
            appendMessage(userQuery, true);
            inputElement.value = '';

            // 2. Disable input and show loading
            sendButton.disabled = true;
            inputElement.disabled = true;
            errorMessageDiv.classList.add('hidden');
            const loadingIndicator = showLoading();

            try {
                // System Instruction to set the persona
                const systemPrompt = "You are Uni-Assist, a friendly and accurate university student assistant. Your goal is to provide concise, factual, and helpful information. Use the available tools (Google Search) to ground your answers in real-time information when necessary. Keep your responses under 3 sentences unless complex explanation is required.";

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // Enable Google Search for grounding and up-to-date info
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const result = await fetchWithRetry(payload);
                
                const candidate = result.candidates?.[0];
                let generatedText = "Sorry, I encountered an issue retrieving the information.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;

                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }
                
                // 3. Remove loading and display bot response
                loadingIndicator.remove();
                appendMessage(generatedText, false, sources);

            } catch (error) {
                console.error("Gemini API Error:", error);
                loadingIndicator.remove();
                errorMessageDiv.textContent = 'Connection error. Please check your network and try again.';
                errorMessageDiv.classList.remove('hidden');
                appendMessage("I'm having trouble connecting right now. Please try again in a moment.", false);
            } finally {
                // 4. Re-enable input
                sendButton.disabled = false;
                inputElement.disabled = false;
                inputElement.focus();
            }
        }
    </script>
</body>
</html>
